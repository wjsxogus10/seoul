import streamlit as st
import pandas as pd
import geopandas
import plotly.express as px
import numpy as np
from shapely.geometry import Point
import os

# ì„œìš¸ì‹œ 25ê°œ ìì¹˜êµ¬ ë¦¬ìŠ¤íŠ¸
seoul_districts_25 = [
    'ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ë…¸ì›êµ¬',
    'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë™êµ¬', 'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬',
    'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬'
]

@st.cache_data
def load_and_process_all_data():
    dashboard_data_df = pd.DataFrame()
    geojson_data = {}
    gdf_seoul_for_map = geopandas.GeoDataFrame()
    seoul_district_areas_df = pd.DataFrame()

    try:
        # [ìˆ˜ì •ë¨] 1. íŒŒì¼ ê²½ë¡œë¥¼ ./data/ ë¡œ ë³€ê²½
        geojso_file_path = './data/BND_SIGUNGU_PG.shp'
        gdf_seoul = geopandas.read_file(geojso_file_path, encoding='cp949')
        gdf_seoul_renamed = gdf_seoul.rename(columns={'SIGUNGU_NM': 'ìì¹˜êµ¬_ì½”ë“œ_ëª…'})
        gdf_seoul_renamed = gdf_seoul_renamed[gdf_seoul_renamed.geometry.is_valid].copy()

        gdf_seoul_filtered = gdf_seoul_renamed[
            gdf_seoul_renamed['ìì¹˜êµ¬_ì½”ë“œ_ëª…'].isin(seoul_districts_25)
        ].copy()
        gdf_seoul_final_for_merge = gdf_seoul_filtered.dissolve(by='ìì¹˜êµ¬_ì½”ë“œ_ëª…', aggfunc='first').reset_index()

        reprojected_gdf_25 = gdf_seoul_final_for_merge.to_crs(epsg=5179)
        reprojected_gdf_25['ë©´ì (kmÂ²)'] = reprojected_gdf_25.geometry.area / 1_000_000
        seoul_district_areas_df = reprojected_gdf_25[['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'ë©´ì (kmÂ²)']].copy()

        gdf_seoul_for_map = gdf_seoul_final_for_merge.to_crs('EPSG:4326')
        geojson_data = gdf_seoul_for_map.__geo_interface__
    except Exception as e:
        st.error(f"ì§€ë¦¬ ë°ì´í„° ë¡œë“œ/ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return pd.DataFrame(), {}, geopandas.GeoDataFrame()

    # [ìˆ˜ì •ë¨] 2. ì¸êµ¬ ë°ì´í„° ê²½ë¡œ ë³€ê²½
    file_path_population = './data/ì„œìš¸ì‹œ ìƒê¶Œë¶„ì„ì„œë¹„ìŠ¤(ìƒì£¼ì¸êµ¬-ìì¹˜êµ¬).csv'
    try:
        df_population = pd.read_csv(file_path_population, encoding='cp949')
        average_population_by_district = df_population.groupby('ìì¹˜êµ¬_ì½”ë“œ_ëª…')['ì´_ìƒì£¼ì¸êµ¬_ìˆ˜'].mean().reset_index()
        average_population_by_district['ìˆœìœ„'] = average_population_by_district['ì´_ìƒì£¼ì¸êµ¬_ìˆ˜'].rank(ascending=False, method='min').astype(int)

        seoul_population_df = average_population_by_district[
            average_population_by_district['ìì¹˜êµ¬_ì½”ë“œ_ëª…'].isin(seoul_districts_25)
        ].copy()
        merged_population_density_df = pd.merge(
            seoul_population_df,
            seoul_district_areas_df,
            on='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
            how='inner'
        )
        merged_population_density_df['ì¸êµ¬_ë°€ë„(ëª…/kmÂ²)'] = (
            merged_population_density_df['ì´_ìƒì£¼ì¸êµ¬_ìˆ˜'] / merged_population_density_df['ë©´ì (kmÂ²)' ]
        )
    except Exception as e:
        st.warning(f"ì¸êµ¬ ë°ì´í„° ë¡œë“œ/ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        merged_population_density_df = pd.DataFrame()

    # [ìˆ˜ì •ë¨] 3. ì •ë¥˜ì¥ ë°ì´í„° ê²½ë¡œ ë³€ê²½
    file_path_station_info = './data/GGD_StationInfo_M.xlsx'
    seoul_bus_stops_df = pd.DataFrame()
    seoul_subway_stations_df = pd.DataFrame()
    merged_bus_density_df = pd.DataFrame()
    merged_subway_density_df = pd.DataFrame()
    seoul_transport_lacking_df = pd.DataFrame()
    try:
        df_station_info_raw = pd.read_excel(file_path_station_info)
        df_station_info_raw['X'] = pd.to_numeric(df_station_info_raw['X'], errors='coerce')
        df_station_info_raw['Y'] = pd.to_numeric(df_station_info_raw['Y'], errors='coerce')
        df_station_info_raw.dropna(subset=['X', 'Y'], inplace=True)

        geometry_stations = [Point(xy) for xy in zip(df_station_info_raw['X'], df_station_info_raw['Y'])]
        gdf_all_stations = geopandas.GeoDataFrame(df_station_info_raw, geometry=geometry_stations, crs='EPSG:4326')

        gdf_seoul_final_for_merge_reprojected_4326 = gdf_seoul_final_for_merge.to_crs('EPSG:4326')

        all_stations_with_districts = geopandas.sjoin(
            gdf_all_stations,
            gdf_seoul_final_for_merge_reprojected_4326[['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'geometry']],
            how='inner',
            predicate='within'
        )
        seoul_bus_stops_df = all_stations_with_districts.groupby('ìì¹˜êµ¬_ì½”ë“œ_ëª…').size().reset_index(name='ë²„ìŠ¤ì •ë¥˜ì¥_ìˆ˜')
        seoul_subway_stations_df = all_stations_with_districts.groupby('ìì¹˜êµ¬_ì½”ë“œ_ëª…').size().reset_index(name='ì§€í•˜ì² ì—­_ìˆ˜')

        merged_bus_density_df = pd.merge(
            seoul_bus_stops_df,
            seoul_district_areas_df,
            on='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
            how='inner'
        )
        merged_bus_density_df['ë²„ìŠ¤ì •ë¥˜ì¥_ë°€ë„(ê°œ/kmÂ²)'] = merged_bus_density_df['ë²„ìŠ¤ì •ë¥˜ì¥_ìˆ˜'] / merged_bus_density_df['ë©´ì (kmÂ²)' ]

        merged_subway_density_df = pd.merge(
            seoul_subway_stations_df,
            seoul_district_areas_df,
            on='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
            how='inner'
        )
        merged_subway_density_df['ì§€í•˜ì² ì—­_ë°€ë„(ê°œ/kmÂ²)'] = merged_subway_density_df['ì§€í•˜ì² ì—­_ìˆ˜'] / merged_subway_density_df['ë©´ì (kmÂ²)' ]

        seoul_public_transport_counts_df = pd.merge(
            seoul_bus_stops_df,
            seoul_subway_stations_df,
            on='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
            how='outer'
        )
        seoul_public_transport_counts_df['ë²„ìŠ¤ì •ë¥˜ì¥_ìˆ˜'] = seoul_public_transport_counts_df['ë²„ìŠ¤ì •ë¥˜ì¥_ìˆ˜'].fillna(0).astype(int)
        seoul_public_transport_counts_df['ì§€í•˜ì² ì—­_ìˆ˜'] = seoul_public_transport_counts_df['ì§€í•˜ì² ì—­_ìˆ˜'].fillna(0).astype(int)

        seoul_public_transport_counts_df['ì •ë¥˜ì¥_ë¶€ì¡±_ìˆœìœ„'] = \
            seoul_public_transport_counts_df['ë²„ìŠ¤ì •ë¥˜ì¥_ìˆ˜'].rank(ascending=True, method='min').astype(int)
        seoul_public_transport_counts_df['ì§€í•˜ì² _ë¶€ì¡±_ìˆœìœ„'] = \
            seoul_public_transport_counts_df['ì§€í•˜ì² ì—­_ìˆ˜'].rank(ascending=True, method='min').astype(int)
        seoul_public_transport_counts_df['ì¢…í•©_êµí†µ_ë¶€ì¡±_ìˆœìœ„'] = \
            seoul_public_transport_counts_df['ì •ë¥˜ì¥_ë¶€ì¡±_ìˆœìœ„'] + seoul_public_transport_counts_df['ì§€í•˜ì² _ë¶€ì¡±_ìˆœìœ„']

        seoul_transport_lacking_df = seoul_public_transport_counts_df[['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'ì •ë¥˜ì¥_ë¶€ì¡±_ìˆœìœ„', 'ì§€í•˜ì² _ë¶€ì¡±_ìˆœìœ„', 'ì¢…í•©_êµí†µ_ë¶€ì¡±_ìˆœìœ„']].copy()

    except Exception as e:
        st.warning(f"êµí†µ ë°ì´í„° ë¡œë“œ/ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    # [ìˆ˜ì •ë¨] 4. ìƒì—… ì‹œì„¤ ë°ì´í„° ê²½ë¡œ ë³€ê²½
    file_path_commercial = './data/ì„œìš¸ì‹œ ìƒê¶Œë¶„ì„ì„œë¹„ìŠ¤(ì§‘ê°ì‹œì„¤-ìì¹˜êµ¬).csv'
    seoul_commercial_facilities_df = pd.DataFrame()
    try:
        df_stores = pd.read_csv(file_path_commercial, encoding='cp949')
        average_stores_by_district = df_stores.groupby('ìì¹˜êµ¬_ì½”ë“œ_ëª…')['ì§‘ê°ì‹œì„¤_ìˆ˜'].mean().reset_index()
        merged_gdf_commercial = gdf_seoul_final_for_merge.merge(average_stores_by_district, on='ìì¹˜êµ¬_ì½”ë“œ_ëª…', how='left')
        merged_gdf_commercial.dropna(subset=['ì§‘ê°ì‹œì„¤_ìˆ˜'], inplace=True)
        merged_gdf_commercial['ì§‘ê°ì‹œì„¤_ìˆ˜'] = merged_gdf_commercial['ì§‘ê°ì‹œì„¤_ìˆ˜'].astype(int)
        seoul_commercial_facilities_df = merged_gdf_commercial[['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'ì§‘ê°ì‹œì„¤_ìˆ˜']].copy()
    except Exception as e:
        st.warning(f"ìƒì—… ì‹œì„¤ ë°ì´í„° ë¡œë“œ/ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

    if not merged_population_density_df.empty:
        dashboard_data_df = merged_population_density_df[
            ['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'ì´_ìƒì£¼ì¸êµ¬_ìˆ˜', 'ì¸êµ¬_ë°€ë„(ëª…/kmÂ²)', 'ë©´ì (kmÂ²)']
        ].copy()

        if not merged_bus_density_df.empty:
            dashboard_data_df = pd.merge(
                dashboard_data_df,
                merged_bus_density_df[['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'ë²„ìŠ¤ì •ë¥˜ì¥_ìˆ˜', 'ë²„ìŠ¤ì •ë¥˜ì¥_ë°€ë„(ê°œ/kmÂ²)']],
                on='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
                how='inner'
            )

        if not merged_subway_density_df.empty:
            dashboard_data_df = pd.merge(
                dashboard_data_df,
                merged_subway_density_df[['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'ì§€í•˜ì² ì—­_ìˆ˜', 'ì§€í•˜ì² ì—­_ë°€ë„(ê°œ/kmÂ²)']],
                on='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
                how='inner'
            )

        if not seoul_commercial_facilities_df.empty:
            dashboard_data_df = pd.merge(
                dashboard_data_df,
                seoul_commercial_facilities_df[['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'ì§‘ê°ì‹œì„¤_ìˆ˜']],
                on='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
                how='inner'
            )

        if not seoul_transport_lacking_df.empty:
            dashboard_data_df = pd.merge(
                dashboard_data_df,
                seoul_transport_lacking_df[['ìì¹˜êµ¬_ì½”ë“œ_ëª…', 'ì •ë¥˜ì¥_ë¶€ì¡±_ìˆœìœ„', 'ì§€í•˜ì² _ë¶€ì¡±_ìˆœìœ„', 'ì¢…í•©_êµí†µ_ë¶€ì¡±_ìˆœìœ„']],
                on='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
                how='inner'
            )
    else:
        st.error("ì¸êµ¬ ë°€ë„ ë°ì´í„°ê°€ ì—†ì–´ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        dashboard_data_df = pd.DataFrame()

    return dashboard_data_df, geojson_data, gdf_seoul_for_map

dashboard_data_df, geojson_data, gdf_seoul_for_map = load_and_process_all_data()

column_display_names = {
    'ìì¹˜êµ¬_ì½”ë“œ_ëª…': 'ìì¹˜êµ¬ëª…',
    'ì´_ìƒì£¼ì¸êµ¬_ìˆ˜': 'ì´ ìƒì£¼ì¸êµ¬ ìˆ˜',
    'ì¸êµ¬_ë°€ë„(ëª…/kmÂ²)': 'ì¸êµ¬ ë°€ë„ (ëª…/kmÂ²)',
    'ë©´ì (kmÂ²)': 'ë©´ì  (kmÂ²)',
    'ë²„ìŠ¤ì •ë¥˜ì¥_ìˆ˜': 'ë²„ìŠ¤ì •ë¥˜ì¥ ìˆ˜',
    'ë²„ìŠ¤ì •ë¥˜ì¥_ë°€ë„(ê°œ/kmÂ²)': 'ë²„ìŠ¤ì •ë¥˜ì¥ ë°€ë„ (ê°œ/kmÂ²)',
    'ì§€í•˜ì² ì—­_ìˆ˜': 'ì§€í•˜ì² ì—­ ìˆ˜',
    'ì§€í•˜ì² ì—­_ë°€ë„(ê°œ/kmÂ²)': 'ì§€í•˜ì² ì—­ ë°€ë„ (ê°œ/kmÂ²)',
    'ì§‘ê°ì‹œì„¤_ìˆ˜': 'ì§‘ê°ì‹œì„¤ ìˆ˜',
    'ì •ë¥˜ì¥_ë¶€ì¡±_ìˆœìœ„': 'ì •ë¥˜ì¥ ë¶€ì¡± ìˆœìœ„',
    'ì§€í•˜ì² _ë¶€ì¡±_ìˆœìœ„': 'ì§€í•˜ì²  ë¶€ì¡± ìˆœìœ„',
    'ì¢…í•©_êµí†µ_ë¶€ì¡±_ìˆœìœ„': 'ì¢…í•© êµí†µ ë¶€ì¡± ìˆœìœ„',
}

st.set_page_config(layout="wide", page_title="ì„œìš¸ì‹œ ë„ì‹œê³„íš ëŒ€ì‹œë³´ë“œ")
st.title("ğŸ™ï¸ ì„œìš¸ì‹œ ë„ì‹œê³„íš ë° ëŒ€ì¤‘êµí†µ ê°œì„  ëŒ€ì‹œë³´ë“œ")
st.markdown("ì„œìš¸ì‹œ 25ê°œ ìì¹˜êµ¬ì˜ ì¸êµ¬, ìƒì—…ì‹œì„¤, ë²„ìŠ¤/ì§€í•˜ì²  ì¸í”„ë¼ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë„ì‹œ ê³„íš ë° ëŒ€ì¤‘êµí†µ ê°œì„  ë°©ì•ˆì„ ëª¨ìƒ‰í•©ë‹ˆë‹¤.")

if dashboard_data_df.empty:
    st.error("ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. './data/' í´ë” ì•ˆì— íŒŒì¼ë“¤ì´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
else:
    col1, col2 = st.columns(2)
    with col1:
        selected_district = st.selectbox(
            "ìì¹˜êµ¬ ì„ íƒ:",
            options=['ì „ì²´ êµ¬'] + sorted(dashboard_data_df['ìì¹˜êµ¬_ì½”ë“œ_ëª…'].unique().tolist()),
            index=0
        )
    with col2:
        metric_options_map = {
            'ì¸êµ¬ ë°€ë„ (ëª…/kmÂ²)': 'ì¸êµ¬_ë°€ë„(ëª…/kmÂ²)',
            'ì§‘ê°ì‹œì„¤ ìˆ˜': 'ì§‘ê°ì‹œì„¤_ìˆ˜',
            'ë²„ìŠ¤ì •ë¥˜ì¥ ë°€ë„ (ê°œ/kmÂ²)': 'ë²„ìŠ¤ì •ë¥˜ì¥_ë°€ë„(ê°œ/kmÂ²)',
            'ì§€í•˜ì² ì—­ ë°€ë„ (ê°œ/kmÂ²)': 'ì§€í•˜ì² ì—­_ë°€ë„(ê°œ/kmÂ²)',
            'ì¢…í•© êµí†µ ë¶€ì¡± ìˆœìœ„': 'ì¢…í•©_êµí†µ_ë¶€ì¡±_ìˆœìœ„'
        }
        selected_metric_map_display = st.selectbox(
            "ì§€ë„ì— í‘œì‹œí•  ì§€í‘œ ì„ íƒ:",
            options=list(metric_options_map.keys()),
            index=0
        )
        selected_metric_map = metric_options_map[selected_metric_map_display]

    st.markdown("---")
    st.subheader(f"ğŸ—ºï¸ ì„œìš¸ì‹œ ìì¹˜êµ¬ë³„ {selected_metric_map_display} ë¶„í¬")

    filtered_df_for_map = dashboard_data_df.copy()
    if selected_district != 'ì „ì²´ êµ¬':
        filtered_df_for_map = filtered_df_for_map[filtered_df_for_map['ìì¹˜êµ¬_ì½”ë“œ_ëª…'] == selected_district]

    center_lat, center_lon = 37.5665, 126.9780
    zoom_level = 9.5

    if selected_district != 'ì „ì²´ êµ¬':
        try:
            selected_gdf = gdf_seoul_for_map[gdf_seoul_for_map['ìì¹˜êµ¬_ì½”ë“œ_ëª…'] == selected_district]
            if not selected_gdf.empty and selected_gdf.geometry.is_valid.all():
                centroid = selected_gdf.geometry.iloc[0].centroid
                center_lon, center_lat = centroid.x, centroid.y
                zoom_level = 11.5
        except Exception:
            pass

    colorscale = 'YlGnBu'
    if selected_metric_map == 'ì¢…í•©_êµí†µ_ë¶€ì¡±_ìˆœìœ„':
        colorscale = 'YlOrRd_r'

    fig_map = px.choropleth_mapbox(
        filtered_df_for_map,
        geojson=geojson_data,
        locations='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
        featureidkey='properties.ìì¹˜êµ¬_ì½”ë“œ_ëª…',
        color=selected_metric_map,
        color_continuous_scale=colorscale,
        mapbox_style="carto-positron",
        zoom=zoom_level,
        center={"lat": center_lat, "lon": center_lon},
        opacity=0.7,
        labels={v: k for k, v in metric_options_map.items()},
        hover_name='ìì¹˜êµ¬_ì½”ë“œ_ëª…'
    )
    fig_map.update_layout(margin={"r":0,"t":0,"l":0,"b":0}, height=600)
    st.plotly_chart(fig_map, use_container_width=True)

    st.markdown("---")
    st.subheader("ğŸ“Š ì£¼ìš” ì§€í‘œ ë¹„êµ")
    
    col3, col4 = st.columns(2)
    with col3:
        metric_options_bar = {v: k for k, v in metric_options_map.items()} # Reverse map
        selected_metric_bar_display = st.selectbox("ë§‰ëŒ€ ì°¨íŠ¸ ì§€í‘œ ì„ íƒ:", options=list(metric_options_bar.values()), index=0)
        selected_metric_bar = [k for k, v in metric_options_bar.items() if v == selected_metric_bar_display][0]

    with col4:
         chart_type_selection = st.radio("í‘œì‹œ ìœ í˜•:", ['ìƒìœ„ 10ê°œ', 'í•˜ìœ„ 10ê°œ'], horizontal=True)

    sorted_df_bar = dashboard_data_df.sort_values(by=selected_metric_bar, ascending=(chart_type_selection == 'í•˜ìœ„ 10ê°œ')).head(10)
    
    fig_bar = px.bar(
        sorted_df_bar,
        x='ìì¹˜êµ¬_ì½”ë“œ_ëª…',
        y=selected_metric_bar,
        title=f"ì„œìš¸ì‹œ {selected_metric_bar_display} {chart_type_selection}",
        labels={'ìì¹˜êµ¬_ì½”ë“œ_ëª…': 'ìì¹˜êµ¬ëª…', selected_metric_bar: selected_metric_bar_display}
    )
    st.plotly_chart(fig_bar, use_container_width=True)

    st.markdown("---")
    st.subheader("ğŸ“‹ ìƒì„¸ ë°ì´í„°")
    st.dataframe(dashboard_data_df.rename(columns=column_display_names), use_container_width=True)